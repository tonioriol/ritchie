apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  labels:
    {{- include "nullclaw.labels" . | nindent 4 }}
data:
  init-config.sh: |
    #!/bin/sh
    set -e
    CFG=/nullclaw-data/.nullclaw/config.json
    mkdir -p /nullclaw-data/.nullclaw /nullclaw-data/workspace
    # Resolve provider/model from env (ExternalSecret) with defaults
    PROVIDER="${NULLCLAW_PROVIDER:-openrouter}"
    MODEL="${NULLCLAW_MODEL:-anthropic/claude-sonnet-4}"
    API_URL="${NULLCLAW_API_URL:-}"
    # Build model primary as provider/model (NullClaw format)
    MODEL_PRIMARY="$PROVIDER/$MODEL"
    # Only write config if it doesn't exist yet
    if [ ! -f "$CFG" ]; then
      cat > "$CFG" <<EOF
    {
      "default_temperature": 0.7,
      "models": {
        "providers": {}
      },
      "agents": {
        "defaults": {
          "model": {
            "primary": "$MODEL_PRIMARY"
          }
        }
      },
      "gateway": {
        "port": {{ .Values.service.port }},
        "host": "::",
        "allow_public_bind": true
      }
    }
    EOF
      # Strip leading whitespace from heredoc (YAML indentation artifact)
      sed -i 's/^    //' "$CFG"
      chmod 600 "$CFG"
    else
      # Update model primary on every restart (env may change via ESO)
      sed -i "s|\"primary\": \"[^\"]*\"|\"primary\": \"$MODEL_PRIMARY\"|" "$CFG"
    fi
