apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  labels:
    {{- include "nullclaw.labels" . | nindent 4 }}
data:
  init-config.sh: |
    #!/bin/sh
    set -e
    CFG=/nullclaw-data/.nullclaw/config.json
    mkdir -p /nullclaw-data/.nullclaw /nullclaw-data/workspace
    # NullClaw v2026+ uses agents.defaults.model.primary = "provider/model"
    # and models.providers.<name>.base_url for custom API endpoints.
    # API_KEY is resolved from env (OPENAI_API_KEY, API_KEY, etc.)
    CCX_URL="${NULLCLAW_CCX_URL:-}"
    # Only write config if it doesn't exist yet
    if [ ! -f "$CFG" ]; then
      if [ -n "$CCX_URL" ]; then
        cat > "$CFG" <<EOF
    {
      "default_temperature": 0.7,
      "models": {
        "providers": {
          "openai": {
            "base_url": "$CCX_URL"
          }
        }
      },
      "agents": {
        "defaults": {
          "model": {
            "primary": "openai/claude-opus-4-6"
          }
        }
      },
      "gateway": {
        "port": {{ .Values.service.port }},
        "host": "::",
        "allow_public_bind": true
      }
    }
    EOF
      else
        cat > "$CFG" <<EOF
    {
      "default_temperature": 0.7,
      "models": {
        "providers": {}
      },
      "agents": {
        "defaults": {
          "model": {
            "primary": "openrouter/anthropic/claude-sonnet-4"
          }
        }
      },
      "gateway": {
        "port": {{ .Values.service.port }},
        "host": "::",
        "allow_public_bind": true
      }
    }
    EOF
      fi
      # Strip leading whitespace from heredoc (YAML indentation artifact)
      sed -i 's/^    //' "$CFG"
      chmod 600 "$CFG"
    else
      # Update base_url on restart if CCX_URL changed
      if [ -n "$CCX_URL" ]; then
        sed -i "s|\"base_url\": \"[^\"]*\"|\"base_url\": \"$CCX_URL\"|" "$CFG"
      fi
    fi
