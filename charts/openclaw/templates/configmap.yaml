apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
data:
  init-config.sh: |
    #!/bin/sh
    set -e
    CFG_DIR=/openclaw-data/config
    CFG="$CFG_DIR/openclaw.json"
    mkdir -p "$CFG_DIR" /openclaw-data/workspace

    # Resolve ccx proxy URL from env (ExternalSecret)
    CCX_URL="${OPENCLAW_CCX_URL:-http://ccx.tools.svc:80/work/v1}"

    # Only write config if it doesn't exist yet â€” preserves gateway token/state
    if [ ! -f "$CFG" ]; then
      cat > "$CFG" <<JSONEOF
    {
      "models": {
        "providers": {
          "ccx": {
            "baseUrl": "$CCX_URL",
            "apiKey": "$API_KEY",
            "api": "openai-completions",
            "models": [
              {
                "id": "claude-opus-4-6",
                "name": "Claude Opus 4.6",
                "reasoning": false,
                "input": ["text", "image"],
                "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
                "contextWindow": 200000,
                "maxTokens": 16384
              }
            ]
          }
        }
      },
      "agents": {
        "defaults": {
          "model": "ccx/claude-opus-4-6",
          "workspace": "/openclaw-data/workspace"
        }
      },
      "gateway": {
        "bind": "lan",
        "port": {{ .Values.service.port }},
        "auth": {
          "token": "$OPENCLAW_GATEWAY_TOKEN"
        }
      }
    }
    JSONEOF
      # Strip leading whitespace from heredoc (YAML indentation artifact)
      sed -i 's/^    //' "$CFG"
      chmod 600 "$CFG"
    else
      echo "Config already exists at $CFG, skipping creation"
    fi
