apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
data:
  init-config.sh: |
    #!/bin/sh
    set -e
    CFG_DIR=/openclaw-data/config
    CFG="$CFG_DIR/openclaw.json"
    mkdir -p "$CFG_DIR" /openclaw-data/workspace

    # Resolve ccx proxy URL from env (ExternalSecret)
    CCX_URL="${OPENCLAW_CCX_URL:-http://ccx.tools.svc:80/work/v1}"

    # Only write config if it doesn't exist yet â€” preserves gateway token/state
    if [ ! -f "$CFG" ]; then
      cat > "$CFG" <<'JSONEOF'
    {
      "models": {
        "providers": {
          "custom": {
            "name": "ccx",
            "apiKey": "${API_KEY}",
            "baseUrl": "CCX_URL_PLACEHOLDER",
            "compatibility": "anthropic"
          }
        }
      },
      "agents": {
        "defaults": {
          "model": "custom/claude-opus-4-6",
          "workspace": "/openclaw-data/workspace"
        }
      },
      "gateway": {
        "bind": "lan",
        "port": {{ .Values.service.port }},
        "auth": {
          "token": "${OPENCLAW_GATEWAY_TOKEN}"
        }
      }
    }
    JSONEOF
      # Strip leading whitespace from heredoc (YAML indentation artifact)
      sed -i 's/^    //' "$CFG"
      # Replace placeholder with actual ccx URL
      sed -i "s|CCX_URL_PLACEHOLDER|$CCX_URL|" "$CFG"
      chmod 600 "$CFG"
    else
      echo "Config already exists at $CFG, skipping creation"
    fi
