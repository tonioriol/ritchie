apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
data:
  init-config.sh: |
    #!/bin/sh
    set -e
    CFG=/zeroclaw-data/.zeroclaw/config.toml
    mkdir -p /zeroclaw-data/.zeroclaw
    # Resolve provider/model from env (ExternalSecret) with defaults
    PROVIDER="${ZEROCLAW_DEFAULT_PROVIDER:-openrouter}"
    MODEL="${ZEROCLAW_DEFAULT_MODEL:-anthropic/claude-sonnet-4-6}"
    # Only write config if it doesn't exist yet â€” preserves persisted paired_tokens
    if [ ! -f "$CFG" ]; then
      cat > "$CFG" <<EOF
    default_provider = "$PROVIDER"
    default_model = "$MODEL"
    default_temperature = 0.7
    provider_api = "openai-chat-completions"

    [gateway]
    host = "0.0.0.0"
    port = {{ .Values.service.port }}
    allow_public_bind = true
    require_pairing = true
    EOF
      # Strip leading whitespace from heredoc (YAML indentation artifact)
      sed -i 's/^    //' "$CFG"
      chmod 600 "$CFG"
    else
      # Update provider/model on every restart (env may change via ESO)
      if grep -q '^default_provider' "$CFG"; then
        sed -i "s|^default_provider = .*|default_provider = \"$PROVIDER\"|" "$CFG"
      else
        sed -i "1i default_provider = \"$PROVIDER\"" "$CFG"
      fi
      if grep -q '^default_model' "$CFG"; then
        sed -i "s|^default_model = .*|default_model = \"$MODEL\"|" "$CFG"
      else
        sed -i "1a default_model = \"$MODEL\"" "$CFG"
      fi
      # Ensure provider_api is set for custom: endpoints
      if ! grep -q '^provider_api' "$CFG"; then
        sed -i '/^default_model/a provider_api = "openai-chat-completions"' "$CFG"
      fi
      # Ensure allow_public_bind is set on existing config
      if ! grep -q 'allow_public_bind' "$CFG"; then
        if grep -q '\[gateway\]' "$CFG"; then
          sed -i '/\[gateway\]/a allow_public_bind = true' "$CFG"
        else
          printf '\n[gateway]\nallow_public_bind = true\n' >> "$CFG"
        fi
      fi
    fi
