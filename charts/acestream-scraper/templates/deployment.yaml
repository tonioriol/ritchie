apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  labels:
    {{- include "acestream-scraper.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "acestream-scraper.labels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "acestream-scraper.labels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      initContainers:
        - name: seed-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              if [ ! -f /config/config.json ]; then
                echo "Seeding initial config.json..."
                cp /seed/config.json /config/config.json
              else
                echo "config.json already exists, skipping seed."
              fi
          volumeMounts:
            - name: config
              mountPath: /config
            - name: seed-config
              mountPath: /seed
        - name: db-migrate
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          command:
            - sh
            - -c
            - |
              echo "Dropping leftover alembic tmp tables (if any)..."
              python -c "
              import sqlite3, os
              db = '/app/config/acestream.db'
              if os.path.exists(db):
                  conn = sqlite3.connect(db)
                  for row in conn.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name LIKE '_alembic_tmp_%'\").fetchall():
                      conn.execute(f'DROP TABLE IF EXISTS [{row[0]}]')
                      print(f'  dropped {row[0]}')
                  conn.commit()
                  conn.close()
              else:
                  print('  no db yet, skipping')
              "
              echo "Running DB migrations..."
              python manage.py upgrade
              echo "Migrations complete."
          env:
            - name: ENABLE_ACESTREAM_ENGINE
              value: "false"
            - name: ENABLE_ACEXY
              value: "false"
            - name: ENABLE_TOR
              value: "false"
            - name: ENABLE_WARP
              value: "false"
          volumeMounts:
            - name: config
              mountPath: /app/config
      containers:
        - name: acestream-scraper
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
          env:
            - name: TZ
              value: "{{ .Values.env.TZ }}"
            - name: FLASK_PORT
              value: "{{ .Values.env.FLASK_PORT }}"
            - name: ENABLE_ACESTREAM_ENGINE
              value: "{{ .Values.env.ENABLE_ACESTREAM_ENGINE }}"
            - name: ENABLE_ACEXY
              value: "{{ .Values.env.ENABLE_ACEXY }}"
            - name: ENABLE_TOR
              value: "{{ .Values.env.ENABLE_TOR }}"
            - name: ENABLE_WARP
              value: "{{ .Values.env.ENABLE_WARP }}"
            - name: ACESTREAM_HTTP_HOST
              value: "{{ .Values.env.ACESTREAM_HTTP_HOST }}"
            - name: ACESTREAM_HTTP_PORT
              value: "{{ .Values.env.ACESTREAM_HTTP_PORT }}"
            - name: ALLOW_REMOTE_ACCESS
              value: "{{ .Values.env.ALLOW_REMOTE_ACCESS }}"
            {{- if .Values.auth.enabled }}
            - name: AUTH_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-auth
                  key: AUTH_USERNAME
            - name: AUTH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-auth
                  key: AUTH_PASSWORD
            {{- end }}
            {{- if .Values.acexyToken }}
            - name: ACEXY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-auth
                  key: ACEXY_TOKEN
            {{- end }}
          volumeMounts:
            - name: config
              mountPath: /app/config
          readinessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
          livenessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 30
      volumes:
        - name: config
          {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-config
          {{- else }}
          emptyDir: {}
          {{- end }}
        - name: seed-config
          configMap:
            name: {{ .Release.Name }}-initial-config
